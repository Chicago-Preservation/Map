<!DOCTYPE html>
<html>


 {% include head.html %}


 <body>


   {% include sidebar.html %}
      <script>
       window.onload = function(){
         if (localStorage['selectedtem'] != undefined){
           new_map();
         } else {
           new_map('{{site.marker-grouping}}');
         }
         reloadhtml();
       };
       window.onhashchange = function() {
         reloadhtml();
       };
      </script>
<div style="position: absolute; top: 10px; left: 50%; transform: translateX(-75%); z-index: 1000;">
  <input type="text" id="searchBox" placeholder="Search by keyword..." 
    style="padding: 8px; width: 250px; border: 2px solid #ccc; border-radius: 4px;">
  <button id="searchBtn" style="padding: 8px 12px; cursor: pointer;">Search</button>
  <div id="searchResults" style="background: white; max-height: 200px; overflow-y: auto; display: none; border: 1px solid #ccc; margin-top: 5px;"></div>
</div>
  
   <div id="map"> </div>


   <script>


   map = L.map('map' , {scrollWheelZoom: false}).setView([41.8781, -87.6298], 12); // Center on Chicago
   var markers = '';
   map.addControl(L.control.attribution({ position: 'bottomleft' }));

    window.change_map = function(){
  localStorage.setItem('selectedtem', document.getElementById("choose").value);
  new_map();
}
    
   function makeMap(markergrouping, map){
     if (markergrouping == 'grouped') { markers = new L.markerClusterGroup({showCoverageOnHover: false});}
     else if (markergrouping == 'single') { markers = new L.featureGroup();}
     var items = {};


     // Base map layer (ESRI Gray Light) 
     L.tileLayer('{{site.map-tileset}}', {
       attribution : '{{site.map-credits}}',
       minZoom : {{site.minZoom}},
       maxZoom : {{site.maxZoom}},
       errorTileUrl : "img/error-tile-image.png",
       subdomains : ["a", "b", "c", "d"],
       detectRetina : true,
     }).addTo(map);
  
     // Existing categories layer control setup
     var overLayers = [];
     var icons = [];


     {% for image in site.static_files %}
       {% if image.path contains 'assets/leaflet/img' %}
         icons.push('{{ image.path }}');
       {% endif %}
     {% endfor %}
 
// boundaries layer

var boundariesLayer = L.geoJSON(null, {
  options: { name: "Boundaries" },
 
 style: function (feature) {
    return {
      color: "#000000",  // Boundary color
      weight: 2,         // Boundary thickness
      fillOpacity: 0     // No fill
    };
  },

  onEachFeature: function (feature, layer) {
    var center = layer.getBounds().getCenter();
    var communityName = feature.properties.community || 'Unknown';

    // Create label but do NOT add it to the map yet
    var labelMarker = L.marker(center, {
      icon: L.divIcon({
        className: 'community-label',
        html: '<div style="font-size: 10px; font-weight: bold; text-align: center;">' + communityName + '</div>',
        iconSize: [80, 15] // Keep label small
      })
    });

    // Function to show/hide labels based on zoom level
    function toggleLabels() {
      if (map.getZoom() >= 14) { // Show labels at zoom level 14 or higher
        if (!map.hasLayer(labelMarker)) {
          map.addLayer(labelMarker);
        }
      } else {
        if (map.hasLayer(labelMarker)) {
          map.removeLayer(labelMarker);
        }
      }
    }

    // Run function when zoom changes
    map.on('zoomend', toggleLabels);

    // Run function once on page load to set initial visibility
    toggleLabels();
  }
});



fetch('GeoJson_files_layers/boundaries.geojson')

  .then(response => response.json())
  .then(data => {
    boundariesLayer.addData(data);
    map.addLayer(boundariesLayer);
    boundariesLayer.bringToBack(); // Ensuring it stays behind all other layers
    // Update checkbox state
    setTimeout(() => {
      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(cb => {
        if (cb.parentElement.textContent.includes('Community Areas')) {
          cb.checked = true;
        }
      });
    }, 500);
  });

  // Added District 2012 layer here

 var nrDistricts2012Layer = L.geoJSON(null, {
  options: { name: "National Register Districts" }, // ðŸ‘ˆ Added unique name
  onEachFeature: function (feature, layer) {
    var popupContent = '<strong>' + (feature.properties.NAME || 'Unknown') + '</strong><br>' +
      '<em>Address:</em> ' + (feature.properties.ADDRESS || 'Unknown') + '<br>' ;
    layer.bindPopup(popupContent);
  },
  style: function (feature) {
    return {
      color: "#90EE90", // **Light Green (Hex for LightGreen)**
      weight: 1,
      fillOpacity: 0.3
    };
  }
});

fetch('GeoJson_files_layers/NR_Districts_2012.geojson')
  .then(response => response.json())
  .then(data => {
    nrDistricts2012Layer.addData(data);
    nrDistricts2012Layer.bringToBack(); // Keeps it behind landmarks but above boundaries
  });

    // Adding other layers (Landmarks and Boundaries)
var landmarksLayer = L.geoJSON(null, {
  options: { name: "Landmarks" }, // ðŸ‘ˆ Added unique name
 
  onEachFeature: function (feature, layer) {
    var popupContent = '<strong>' + (feature.properties.NAME || 'Unknown') + '</strong><br>' +
      '<em>Architect:</em> ' + (feature.properties.ARCHITECT || 'Unknown') + '<br>' +
      '<em>Address:</em> ' + (feature.properties.ADDRESS || 'Unknown') + '<br>' +
      '<em>Date Built:</em> ' + (feature.properties.DATE_BUILT || 'Unknown');
    layer.bindPopup(popupContent);
  }
});

fetch('GeoJson_files_layers/landmarkareas.geojson')
  .then(response => response.json())
  .then(data => {
    landmarksLayer.addData(data);
    map.addLayer(landmarksLayer);
   // Update checkbox state
    setTimeout(() => {
      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(cb => {
        // Find the checkbox associated with landmarks layer
        if (cb.parentElement.textContent.includes('Chicago Landmarks')) {
          cb.checked = true;
        }
      });
    }, 500);
  });
  
/// Adding Historic Resources Survey Layer
var historicResourcesLayer = L.geoJSON(null, {
  options: { name: "Historic Resources Survey" }, // ðŸ‘ˆ Added unique name

  onEachFeature: function (feature, layer) {
    var startYear = feature.properties["STARTYEAR"];
    var decade = feature.properties["DECADE"];

    var startYear = parseInt(feature.properties["STARTYEAR"], 10);
    var displayYear = (startYear && startYear !== 0) ? startYear : ((decade && decade !== 0) ? decade : 'NA');



    var popupContent = '<strong>' +
      (feature.properties["LANDMARKNA"] || 'No Name') + '</strong><br>' +
      '<em>Address:</em> ' + (feature.properties["ADDRESSDES"] || 'Unknown') + '<br>' +
      '<em>Year:</em> ' + displayYear;

    layer.bindPopup(popupContent);
  },
  style: function (feature) {
    return {
      color: "#FF5733", // **Orange color**
      weight: 2,
      fillOpacity: 0.5
    };
  }
});

// Fetch and Add Historic Resources Survey GeoJSON Data
fetch('GeoJson_files_layers/Historic_Resources_Survey.geojson')
  .then(response => response.json())
  .then(data => {
    historicResourcesLayer.addData(data);
  });

// Adding NR_Properties Layer
var nrPropertiesFilteredLayer = L.geoJSON(null, {
  options: { name: "NR Properties" },
 onEachFeature: function (feature, layer) {
    var props = feature.properties;
    var popupContent = '<strong>' + (props.SignificantName || 'N/A') + '</strong><br>' +
      (props.Location ? '<em>Location:</em> ' + props.Location + '<br>' : '') +
      '<em>Architect:</em> ' + (props.Architect || 'N/A') + '<br>' +
      (props.BeginYear ? '<em>Year:</em> ' + props.BeginYear + '<br>' : '') +
      (props.SurveyType ? '<em>Survey Type:</em> ' + props.SurveyType + '<br>' : '') +
      (props.SurveyDate ? '<em>Survey Date:</em> ' + props.SurveyDate + '<br>' : '');
    
    // Add photo as thumbnail if it exists
    if (props.Url_img && props.Url_img.trim() !== "") {
      popupContent += '<a href="' + props.Url_img + '" target="_blank">' +
        '<img src="' + props.Url_img + '" style="width:200px; height:auto; margin-top:5px;"><br></a>';
    }
    
    // Add attachment link if it exists
    if (props.URL && props.URL.trim() !== "") {
      popupContent += '<em>Attachment:</em> ' +
        '<a href="' + props.URL + 
        '" target="_blank" style="color:#0073e6; text-decoration:underline;">Open Document</a><br>';
    }
    
    layer.bindPopup(popupContent);
  },
  pointToLayer: function (feature, latlng) {
    return L.circleMarker(latlng, {
      radius: 4,
      fillColor: "#006400", 
      color: "#003300",
      weight: 1,
      opacity: 1,
      fillOpacity: 0.8
    });
  }
});

// Fetch GeoJSON data
fetch('GeoJson_files_layers/NR_Properties.geojson')
  .then(response => response.json())
  .then(data => {
    nrPropertiesFilteredLayer.addData(data);
    nrPropertiesFilteredLayer.bringToFront();
  });


// Adding Mural Registry Layer
var muralRegistryLayer = L.geoJSON(null, {
  options: { name: "Mural Registry Layer" }, // ðŸ‘ˆ Added unique name

  onEachFeature: function (feature, layer) {
    var popupContent = '<strong>' + (feature.properties["Artwork Title"] || 'Unknown') + '</strong><br>' +
      '<em>Artist:</em> ' + (feature.properties["Artist Credit"] || 'Unknown') + '<br>' +
      '<em>Year:</em> ' + (feature.properties["Year Installed"] || 'Unknown') + '<br>' +
      '<em>Street Address:</em> ' + (feature.properties["Street Address"] || 'Unknown');
    layer.bindPopup(popupContent);
  },
  pointToLayer: function (feature, latlng) {
    return L.circleMarker(latlng, {
      radius: 5, // Size of the marker
      fillColor: "#6a0dad", // Purple color for murals
      color: "#ffffff", // White border
      weight: 1,
      opacity: 1,
      fillOpacity: 0.8
    });
  }
});

// Fetch and Add Mural Registry GeoJSON Data
fetch('GeoJson_files_layers/mural_registry.geojson')
  .then(response => response.json())
  .then(data => {
    muralRegistryLayer.addData(data);
    muralRegistryLayer.bringToFront(); // Ensures murals stay at the top
  });

// NEW: Adding Gentrification Layer
var gentrificationLayer = L.geoJSON(null, {
  options: { name: "Gentrification Analysis" },
 
  style: function (feature) {
    var typology = feature.properties.Typology;
    var colors = {
      'Low-Income/Susceptible to Displacement': '#FDE8E8',
      'Ongoing Displacement': '#FCBABA',
      'At Risk of Gentrification': '#F87171',
      'Early/Ongoing Gentrification': '#EF4444',
      'Advanced Gentrification': '#DC2626',
      'Stable Moderate/Mixed Income': '#B91C1C',
      'At Risk of Becoming Exclusive': '#991B1B',
      'Becoming Exclusive': '#7F1D1D',
      'Stable/Advanced Exclusive': '#450A0A'
    };
    
    return {
      color: colors[typology] || '#808080',
      fillColor: colors[typology] || '#808080',
      weight: 2,
      fillOpacity: 0.6,
      opacity: 0.8
    };
  },
  
  onEachFeature: function (feature, layer) {
    var popupContent = '<strong>' + (feature.properties.name || feature.properties.community_area || 'Area') + '</strong><br>' +
      '<em>Typology:</em> ' + (feature.properties.Typology || 'Unknown') + '<br>';
    layer.bindPopup(popupContent);
  }
});

// Load the GeoJSON data
fetch('GeoJson_files_layers/Gentrification.geojson')
  .then(response => response.json())
  .then(data => {
    gentrificationLayer.addData(data);
  })
  .catch(error => {
    console.log('Could not load Gentrification.geojson:', error);
  });

// CREATE A COLOR LEGEND for the gentrification layer - SIMPLIFIED VERSION
var gentrificationLegend = L.control({position: 'bottomleft'});

gentrificationLegend.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'gentrification-legend');
    div.style.background = 'white';
    div.style.border = '2px solid black';
    div.style.borderRadius = '5px';
    div.style.padding = '10px';
    div.style.fontSize = '12px';
    div.style.display = 'none';
    div.style.zIndex = '1000';
    
  div.innerHTML = '<strong style="color: black;">Gentrification Typology</strong><br>' +
        '<div style="margin: 3px 0;"><span style="background: #FDE8E8; padding: 2px 5px; border: 1px solid #ccc;">Low-Income/Susceptible to Displacement</span></div>' +
        '<div style="margin: 3px 0;"><span style="background: #FCBABA; padding: 2px 5px; border: 1px solid #ccc;">Ongoing Displacement</span></div>' +
        '<div style="margin: 3px 0;"><span style="background: #F87171; padding: 2px 5px; border: 1px solid #ccc;">At Risk of Gentrification</span></div>' +
        '<div style="margin: 3px 0;"><span style="background: #EF4444; padding: 2px 5px; border: 1px solid #ccc;">Early/Ongoing Gentrification</span></div>' +
        '<div style="margin: 3px 0;"><span style="background: #DC2626; padding: 2px 5px; border: 1px solid #ccc; color: white;">Advanced Gentrification</span></div>' +
        '<div style="margin: 3px 0;"><span style="background: #B91C1C; padding: 2px 5px; border: 1px solid #ccc; color: white;">Stable Moderate/Mixed Income</span></div>' +
        '<div style="margin: 3px 0;"><span style="background: #991B1B; padding: 2px 5px; border: 1px solid #ccc; color: white;">At Risk of Becoming Exclusive</span></div>' +
        '<div style="margin: 3px 0;"><span style="background: #7F1D1D; padding: 2px 5px; border: 1px solid #ccc; color: white;">Becoming Exclusive</span></div>' +
        '<div style="margin: 3px 0;"><span style="background: #450A0A; padding: 2px 5px; border: 1px solid #ccc; color: white;">Stable/Advanced Exclusive</span></div>';
    
    return div;
};

// Add the legend to the map immediately (always present but hidden)
gentrificationLegend.addTo(map);  

   // Race/Ethnicity Layer
var raceEthnicityLayer = L.geoJSON(null, {
  options: { name: "Race/Ethnicity Analysis" },
  
  style: function (feature) {
    var majority = feature.properties["Majority Race/Ethnicity"];
       var communityName = feature.properties.community;
    
    // Debug - remove this once it works
    if (communityName === 'ARMOUR SQUARE') {
        console.log('Matched ARMOUR SQUARE exactly!');
    }
    
    // Special case for Armour Square (exact match)
    if (communityName === 'ARMOUR SQUARE') {
        return {
            color: '#9932CC',
            fillColor: '#9932CC',
            weight: 2,
            fillOpacity: 0.6,
            opacity: 0.8
        };
    }
    var colors = {
      'Majority White': '#4682B4',                           // Steel blue
      'Majority Black or African Amer': '#2E8B57',      // Sea green
      'Majority Hispanic or Latino': '#CD853F',             // Peru
      'No Majority': '#808080'                              // Gray
    };
    
    return {
      color: colors[majority] || '#808080',
      fillColor: colors[majority] || '#808080',
      weight: 2,
      fillOpacity: 0.6,
      opacity: 0.8
    };
  },
  
onEachFeature: function (feature, layer) {
  var props = feature.properties;
  
  // Remove commas and convert to number
  function toNum(value) {
    if (!value) return 0;
    return parseFloat((value + '').replace(/,/g, '')) || 0;
  }
  
  var total = toNum(props["Total Population"]);
  
  function getPct(value) {
    var num = toNum(value);
    if (num === 0 || total === 0) return '0%';
    return ((num / total) * 100).toFixed(0) + '%';
  }
  
  var popupContent = '<strong>' + (props.community || 'Community Area') + '</strong><br>' +
    '<em>Total Population:</em> ' + (props["Total Population"] || 'N/A') + '<br>' +
    '<em>White:</em> ' + getPct(props["White"]) + '<br>' +
    '<em>Black or African American:</em> ' + getPct(props["Black or African American"]) + '<br>' +
    '<em>American Indian or Alaska Native:</em> ' + getPct(props["American Indian or Alaska Native"]) + '<br>' +
    '<em>Asian:</em> ' + getPct(props["Asian"]) + '<br>' +
    '<em>Native Hawaiian or Pacific Islander:</em> ' + getPct(props["Native Hawaiian or Pacific Islander"]) + '<br>' +
    '<em>Other Race:</em> ' + getPct(props["Other Race"]) + '<br>' +
    '<em>Multiracial:</em> ' + getPct(props["Multiracial"]) + '<br>' +
    '<em>Hispanic or Latino:</em> ' + getPct(props["Hispanic or Latino"]);
  
  layer.bindPopup(popupContent);
}
});
    
// Load the Race/Ethnicity GeoJSON data
fetch('GeoJson_files_layers/Race and Ethnicity.geojson')
  .then(response => response.json())
  .then(data => {
    raceEthnicityLayer.addData(data);
  })
  .catch(error => {
    console.log('Could not load Race and Ethnicity.geojson:', error);
  });

    // CREATE A COLOR LEGEND for the race/ethnicity layer
var raceEthnicityLegend = L.control({position: 'bottomleft'});

raceEthnicityLegend.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'race-ethnicity-legend');
    div.style.background = 'white';
    div.style.border = '2px solid black';
    div.style.borderRadius = '5px';
    div.style.padding = '10px';
    div.style.fontSize = '12px';
    div.style.display = 'none';
    div.style.zIndex = '1000';
    
    div.innerHTML = '<strong style="color: black;">Race/Ethnicity Majority</strong><br>' +
        '<div style="margin: 3px 0;"><span style="background: #4682B4; padding: 2px 5px; border: 1px solid #ccc; color: white;">Majority White</span></div>' +
        '<div style="margin: 3px 0;"><span style="background: #2E8B57; padding: 2px 5px; border: 1px solid #ccc; color: white;">Majority Black or African American</span></div>' +
        '<div style="margin: 3px 0;"><span style="background: #CD853F; padding: 2px 5px; border: 1px solid #ccc; color: white;">Majority Hispanic or Latino</span></div>' +
        '<div style="margin: 3px 0;"><span style="background: #9932CC; padding: 2px 5px; border: 1px solid #ccc; color: white;">Majority Asian</span></div>' +
        '<div style="margin: 3px 0;"><span style="background: #808080; padding: 2px 5px; border: 1px solid #ccc; color: white;">No Majority</span></div>';
    
    return div;
};

// Add the race/ethnicity legend to the map immediately (always present but hidden)
raceEthnicityLegend.addTo(map);

  // Financial Data Layer
var financialDataLayer = L.geoJSON(null, {
  options: { name: "Financial Data" },
  
  style: function (feature) {
    var medianIncome = feature.properties.MEDINC;
    var color;
    
    // Check for N/A, null, undefined, or non-numeric values first
    if (medianIncome === 'N/A' || medianIncome === '$N/A' || 
        medianIncome === null || medianIncome === undefined || 
        isNaN(medianIncome) || medianIncome === '') {
        // Don't fill areas with no data - make them transparent
        return {
            color: '#808080',      // Light gray border
            fillColor: 'transparent',  // No fill
            weight: 1,
            fillOpacity: 0,
            opacity: 0.3
        };
    }
    
    // Color by median income for valid values
    if (medianIncome >= 100000) {
        color = '#006400';      // Dark green - high income
    } else if (medianIncome >= 75000) {
        color = '#32CD32';      // Lime green
    } else if (medianIncome >= 50000) {
        color = '#FFD700';      // Gold - middle income
    } else if (medianIncome >= 25000) {
        color = '#FF8C00';      // Orange
    } else {
        color = '#DC143C';      // Crimson - low income
    }
    
    return {
        color: color,
        fillColor: color,
        weight: 2,
        fillOpacity: 0.6,
        opacity: 0.8
    };
},
  
  onEachFeature: function (feature, layer) {
    var props = feature.properties;
    var popupContent = '<strong>' + (props.community || 'Community Area') + '</strong><br>' +
      '<em>Median Income:</em> $' + (props.MEDINC ? Math.round(props.MEDINC).toLocaleString() : 'N/A') + '<br>' +
      '<em>Median Rent:</em> $' + (props.MED_RENT ? Math.round(props.MED_RENT).toLocaleString() : 'N/A') + '<br>' +
      '<em>Median Home Value:</em> $' + (props.MED_HV ? Math.round(props.MED_HV).toLocaleString() : 'N/A');
    
    layer.bindPopup(popupContent);
  }
});

// Load the Financial Data GeoJSON
fetch('GeoJson_files_layers/Financial Data.geojson')
  .then(response => response.json())
  .then(data => {
    financialDataLayer.addData(data);
  })
  .catch(error => {
    console.log('Could not load Financial Data.geojson:', error);
  });

// Financial Data Legend
var financialDataLegend = L.control({position: 'bottomleft'});

financialDataLegend.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'financial-data-legend');
    div.style.background = 'white';
    div.style.border = '2px solid black';
    div.style.borderRadius = '5px';
    div.style.padding = '10px';
    div.style.fontSize = '12px';
    div.style.display = 'none';
    div.style.zIndex = '1000';
    
    div.innerHTML = '<strong style="color: black;">Median Income</strong><br>' +
        '<div style="margin: 3px 0;"><span style="background: #006400; padding: 2px 5px; border: 1px solid #ccc; color: white;">$100,000+</span></div>' +
        '<div style="margin: 3px 0;"><span style="background: #32CD32; padding: 2px 5px; border: 1px solid #ccc; color: black;">$75,000 - $99,999</span></div>' +
        '<div style="margin: 3px 0;"><span style="background: #FFD700; padding: 2px 5px; border: 1px solid #ccc; color: black;">$50,000 - $74,999</span></div>' +
        '<div style="margin: 3px 0;"><span style="background: #FF8C00; padding: 2px 5px; border: 1px solid #ccc; color: white;">$25,000 - $49,999</span></div>' +
        '<div style="margin: 3px 0;"><span style="background: #DC143C; padding: 2px 5px; border: 1px solid #ccc; color: white;">Under $25,000</span></div>';
    
    return div;
};

financialDataLegend.addTo(map);

// Simple layer ordering - put demographic layers behind all others
setTimeout(() => {
    if (map.hasLayer(gentrificationLayer)) gentrificationLayer.bringToBack();
    if (map.hasLayer(raceEthnicityLayer)) raceEthnicityLayer.bringToBack();
    if (map.hasLayer(financialDataLayer)) financialDataLayer.bringToBack();  // Add this line
    if (map.hasLayer(boundariesLayer)) boundariesLayer.bringToBack();
}, 50);
 
// GeoJSON Layers (New Layer Control for GeoJSON in the bottom-right)
if (window.innerWidth <= 768) {
  const leftContainer = document.querySelector('.leaflet-bottom.leaflet-left');

  const panel = document.querySelector('.leaflet-control-layers'); // âœ… applies to both PanelLayers and control-layers
  if (panel && leftContainer && !leftContainer.contains(panel)) {
    leftContainer.appendChild(panel);
  }

  setTimeout(() => {


    // Style the panel
    panel.style.maxWidth = '45vw';
    panel.style.maxHeight = '40vh';
    panel.style.fontSize = '13px';
    panel.style.overflowY = 'auto';
    panel.style.background = 'rgba(255,255,255,0.95)';
    panel.style.borderRadius = '10px';
    panel.style.padding = '10px';
    panel.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
    panel.style.display = 'block'; // initially hidden

    // Add toggle button
    const toggleBtn = document.createElement('button');
    toggleBtn.id = 'toggle-panel-btn';
    toggleBtn.className = 'toggle-panel-btn';
    toggleBtn.innerText = 'Map Layers âŒ„';

    const mapContainer = document.getElementById('map');
    if (mapContainer) mapContainer.appendChild(toggleBtn);

    toggleBtn.addEventListener('click', () => {
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    });
  }, 300);
}


     // Set map view
     map.setView([41.8781, -87.6298], 12); // Center on Chicago
     //map.fitBounds(markers.getBounds());

    // --- Create Student 'Category' Layer ---
    const studentCategoryLayer = L.layerGroup();

    // Define the icon just once outside the loop for efficiency
    const categoryIconUrl = "{{site.baseurl}}/assets/leaflet/img/noun_33862_cc_green.svg";
    const categoryIcon = L.icon({
      iconUrl: categoryIconUrl,
      iconSize : [50, 54],
      iconAnchor : [17, 36],
      popupAnchor : [-1, 8]
    });

    {% for post in site.categories['Category'] %}
      lat = {{ post.lat }};
      lng = {{ post.lng }};
      content = "<strong>{{ post.title }}</strong><br>{{ post.desc }}";

      var marker = L.marker([lat, lng], { icon: categoryIcon }).bindPopup(content, {offset:new L.Point(0,-30)});

      marker.iconURL = categoryIconUrl; 

      marker.on('click', function(){
        post_url = "{{site.baseurl}}/#{{post.url}}";
        article_url = '{{site.baseurl}}{{post.url}}';
        item_id = "{{post.url}}";
        window.location = (post_url);
        articlerender(article_url, item_id);
      });

      marker.addTo(studentCategoryLayer);

      var filename = "{{post.url}}";
      if (items[filename] === undefined) {
        items[filename] = [marker];
      }
    {% endfor %}

    map.addLayer(studentCategoryLayer);
    console.log('Number of markers in Category layer:', studentCategoryLayer.getLayers().length);

    // --- NEW HIERARCHICAL LEGEND CODE ---

    // 1. This part defines the structure of our new legend.
    //
    // --- DEVELOPER TEMPLATE & GUIDE ---
    // To add new items to the legend, modify this `legendData` object.
    //
    // HOW TO ADD A NEW LAYER (SUB-OPTION) TO AN EXISTING CATEGORY:
    //   1. Make sure the layer variable (e.g., `myNewLayer`) is defined first.
    //   2. Find the 'category' you want to add it to below.
    //   3. Add a new object to its `subOptions` array, following the format:
    //      { name: 'The Display Name for the Layer', layer: myNewLayer }
    //
    // HOW TO ADD A NEW CATEGORY (MAIN OPTION):
    //   1. Add a new object to the main `legendData` array below.
    //   2. Follow this structure:
    //      {
    //          category: "My New Category Title",
    //          subOptions: [
    //              { name: 'Layer 1 Name', layer: layer1Variable },
    //              { name: 'Layer 2 Name', layer: layer2Variable }
    //          ]
    //      }
    // --- END OF GUIDE ---

const legendData = [
    {
        category: "Historic Recognition",
        subOptions: [
            { name: '<a href="https://webapps1.chicago.gov/landmarksweb/web/listings.htm" target="_blank">Chicago Landmarks</a>', layer: landmarksLayer },
            { name: '<a href="https://www.nps.gov/subjects/nationalregister/index.htm" target="_blank">National Register of Historic Places</a>', layer: nrPropertiesFilteredLayer },
            { name: '<a href="https://www.nps.gov/subjects/nationalregister/index.htm" target="_blank">National Register Districts</a>', layer: nrDistricts2012Layer },
            { name: '<a href="https://www.chicago.gov/city/en/depts/dca/supp_info/mural_registry.html" target="_blank">Mural Registry</a>', layer: muralRegistryLayer },
            { name: '<a href="https://www.preservationchicago.org/resources/chicago-historic-resources-survey-chrs/" target="_blank">Historic Resources Survey</a>', layer: historicResourcesLayer },
            { name: '<a href="https://www.chicago.gov/city/en/depts/2fm/supp_info/citywide_maps.html" target="_blank">Community Areas</a>', layer: boundariesLayer }
        ]
    },
    {
        category: "Urban Phenomena",                    // â† MOVED THIS UP
        subOptions: [
            { name: 'Gentrification Analysis', layer: gentrificationLayer },
          { name: 'Race/Ethnicity', layer: raceEthnicityLayer },
         { name: 'Financial Data', layer: financialDataLayer }
        ]
    },
    {
        category: "Student Projects",                   // â† ADDED COMMA HERE
        subOptions: [
            { name: 'Category', layer: studentCategoryLayer }
        ]
    }
];

    // 2. This function builds the HTML for the new collapsible legend.
    function buildHierarchicalLegend(data) {
        const container = L.DomUtil.create('div', 'leaflet-control-layers leaflet-control-layers-expanded leaflet-control');
        container.style.padding = '10px';
        container.style.background = 'rgba(255, 255, 255, 0.95)';
        container.style.border = '1px solid #aaa';
        container.setAttribute('aria-haspopup', true);

        L.DomEvent.disableClickPropagation(container);

        data.forEach(categoryObj => {
            const header = L.DomUtil.create('h4', 'legend-category-header', container);
            // Start with collapsed arrow for certain categories
if (categoryObj.category === 'Urban Phenomena' || categoryObj.category === 'Student Projects') {
    header.innerHTML = `â–º ${categoryObj.category}`;
} else {
    header.innerHTML = `â–¼ ${categoryObj.category}`;
}
            header.style.cursor = 'pointer';
            header.style.margin = '5px 0';
            header.style.fontSize = '16px';
            header.style.userSelect = 'none';

            const subOptionsContainer = L.DomUtil.create('div', 'legend-sub-options', container);

         // Start Urban Phenomena and Student Projects collapsed
if (categoryObj.category === 'Urban Phenomena' || categoryObj.category === 'Student Projects') {
    subOptionsContainer.style.display = 'none';
}

            categoryObj.subOptions.forEach(subOption => {
                const item = L.DomUtil.create('div', '', subOptionsContainer);
                item.style.paddingLeft = '15px';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.style.marginRight = '5px';

checkbox.onchange = function(e) {
    if (e.target.checked) {
        if (!map.hasLayer(subOption.layer)) {
            map.addLayer(subOption.layer);
            
            // Apply layer ordering
            setTimeout(() => {
                if (map.hasLayer(gentrificationLayer)) gentrificationLayer.bringToBack();
                if (map.hasLayer(raceEthnicityLayer)) raceEthnicityLayer.bringToBack();
                if (map.hasLayer(financialDataLayer)) financialDataLayer.bringToBack();
                if (map.hasLayer(boundariesLayer)) boundariesLayer.bringToBack();
            }, 50);
            
            // Show appropriate legends
            if (subOption.layer === gentrificationLayer) {
                var legendDiv = document.querySelector('.gentrification-legend');
                if (legendDiv) legendDiv.style.display = 'block';
            }
            if (subOption.layer === raceEthnicityLayer) {
                var legendDiv = document.querySelector('.race-ethnicity-legend');
                if (legendDiv) legendDiv.style.display = 'block';
            }
            if (subOption.layer === financialDataLayer) {
                var legendDiv = document.querySelector('.financial-data-legend');
                if (legendDiv) legendDiv.style.display = 'block';
            }
        }
    } else {
        if (map.hasLayer(subOption.layer)) {
            map.removeLayer(subOption.layer);
            
            // Hide appropriate legends
            if (subOption.layer === gentrificationLayer) {
                var legendDiv = document.querySelector('.gentrification-legend');
                if (legendDiv) legendDiv.style.display = 'none';
            }
            if (subOption.layer === raceEthnicityLayer) {
                var legendDiv = document.querySelector('.race-ethnicity-legend');
                if (legendDiv) legendDiv.style.display = 'none';
            }
            if (subOption.layer === financialDataLayer) {
                var legendDiv = document.querySelector('.financial-data-legend');
                if (legendDiv) legendDiv.style.display = 'none';
            }
        }
    }
};
                
                map.on('overlayadd', (e) => {
                    if(e.layer === subOption.layer) checkbox.checked = true;
                });
                map.on('overlayremove', (e) => {
                    if(e.layer === subOption.layer) checkbox.checked = false;
                });

                const label = document.createElement('label');
                label.style.display = 'flex';
                label.style.alignItems = 'center';
                label.style.fontSize = '14px';
                label.appendChild(checkbox);
                
                const nameSpan = document.createElement('span');
                nameSpan.innerHTML = subOption.name;
                label.appendChild(nameSpan);

                item.appendChild(label);
            });

            header.onclick = function() {
                const isHidden = subOptionsContainer.style.display === 'none';
                subOptionsContainer.style.display = isHidden ? 'block' : 'none';
                header.innerHTML = isHidden ? `â–¼ ${categoryObj.category}` : `â–º ${categoryObj.category}`;
            };
        });

        return container;
    }

      // 3. This creates the new legend and adds it to the map.
      const newLegendControl = L.control({position: 'bottomright'});
      newLegendControl.onAdd = function(map) {
          return buildHierarchicalLegend(legendData);
      };
      newLegendControl.addTo(map);

      // --- END OF NEW HIERARCHICAL LEGEND CODE ---

     return items;
   }

    // Search functionality
document.getElementById('searchBtn').addEventListener('click', performSearch);
document.getElementById('searchBox').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') performSearch();
});

function performSearch() {
  var keyword = document.getElementById('searchBox').value.toLowerCase().trim();
  var results = [];
  
  if (!keyword) return;
  
  // Search NR Properties
  nrPropertiesLayer.eachLayer(function(layer) {
    var props = layer.feature.properties;
    var name = (props.SignificantName || '').toLowerCase();
    var location = (props.Location || '').toLowerCase();
    var architect = (props.Architect || '').toLowerCase();
    
    if (name.includes(keyword) || location.includes(keyword) || architect.includes(keyword)) {
      results.push({layer: layer, name: props.SignificantName || 'N/A', location: props.Location || ''});
    }
  });
  
  displayResults(results);
}

function displayResults(results) {
  var resultsDiv = document.getElementById('searchResults');
  
  if (results.length === 0) {
    resultsDiv.innerHTML = '<div style="padding: 10px;">No results found</div>';
    resultsDiv.style.display = 'block';
    return;
  }
  
  var html = '';
  results.forEach(function(result, index) {
    html += '<div style="padding: 8px; cursor: pointer; border-bottom: 1px solid #eee;" ' +
      'onclick="zoomToResult(' + index + ')">' +
      '<strong>' + result.name + '</strong><br>' +
      '<small>' + result.location + '</small></div>';
  });
  
  resultsDiv.innerHTML = html;
  resultsDiv.style.display = 'block';
  
  // Store results globally for zoom function
  window.searchResults = results;
}

function zoomToResult(index) {
  var result = window.searchResults[index];
  map.setView(result.layer.getLatLng(), 18);
  result.layer.openPopup();
  document.getElementById('searchResults').style.display = 'none';
}
    
   </script>
   {% include menu.html %}
   {% include dropdown.html %}
 </body>
</html>
