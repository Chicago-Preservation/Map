<!DOCTYPE html> 
<html>

  {% include head.html %}

  <body>

    {% include sidebar.html %}

    <script>
      window.onload = function(){
        if (localStorage['selectedtem'] != undefined){
          new_map();
        } else {
          new_map('{{site.marker-grouping}}');
        }
        reloadhtml();
      };
      
      window.onhashchange = function() {
        reloadhtml();
      };
    </script>

    <div id="map"> </div>

    <script>
      // Initialize the map and set center on Chicago
      var map = L.map('map' , {scrollWheelZoom: false}).setView([41.8781, -87.6298], 12);
      var markers = '';

      window.change_map = function(){
        localStorage.setItem('selectedtem', document.getElementById("choose").value);
        new_map();
      };

      function makeMap(markergrouping, map){
        if (markergrouping == 'grouped') {
          markers = new L.markerClusterGroup({showCoverageOnHover: false});
        } else if (markergrouping == 'single') {
          markers = new L.featureGroup();
        }
        var items = {};

        // Base map layer (ESRI Gray Light)
        L.tileLayer('{{site.map-tileset}}', {
          attribution : '{{site.map-credits}}',
          minZoom : {{site.minZoom}},
          maxZoom : {{site.maxZoom}},
          errorTileUrl : "img/error-tile-image.png",
          subdomains : ["a", "b", "c", "d"],
          detectRetina : true,
        }).addTo(map);

        // Custom control for the "Categories" title
        var categoriesTitleControl = L.Control.extend({
          options: { position: 'topleft' },
          onAdd: function (map) {
            var container = L.DomUtil.create('div', 'leaflet-control-layers-title');
            container.innerHTML = '<h4>Categories</h4>';
            return container;
          }
        });

        // Add the title control for categories
        map.addControl(new categoriesTitleControl());

        // Loop through categories and add layer controls
        var overLayers = [];
        var icons = [];

        {% for image in site.static_files %}
          {% if image.path contains 'assets/leaflet/img' %}
            icons.push('{{ image.path }}');
          {% endif %}
        {% endfor %}

        var counter = -1;
        var groups = {};

        {% for category in site.categories %}
        counter += 1;
        var layers = [];
        if (markergrouping == 'grouped') {
          groups[counter] = L.featureGroup.subGroup(markers);
          var control = L.control.layers(null, null, { collapsed: false, position: 'topleft' });
        }

        {% for post in site.categories[category_name] %}
        var lat = {{ post.lat }};
        var lng = {{ post.lng }};
        var content = $(window).height() < {{site.window-height}} || $(window).width() < {{site.window-width}} ?
                      "<strong>{{ post.title | truncatewords: 2}}</strong>" :
                      "<strong>{{ post.title }}</strong><br>{{ post.desc }}";

        var iconurl = "{{site.baseurl}}" + icons[counter];
        var mbox = L.icon({
          iconUrl: iconurl,
          iconSize : [46, 50],
          iconAnchor : [17, 36],
          popupAnchor : [-1, 8]
        });
        var marker = L.marker([lat, lng], { icon: mbox }).bindPopup(content, {offset:new L.Point(0,-30)});
        marker.iconURL = iconurl;

        if (markergrouping == 'grouped') {
          marker.addTo(groups[counter]);
        } else if (markergrouping == 'single') {
          layers.push(marker);
        }

        var filename = "{{post.url}}";
        if (items[filename] == undefined) {
          items[filename] = [marker];
        } else {
          items[filename].push(marker);
        }

        marker.on('click', function(){
          window.location = "{{site.baseurl}}/#{{post.url}}";
          articlerender('{{site.baseurl}}{{post.url}}', "{{post.url}}");
        });

        {% endfor %}

        var imageurl = '<img class="legend" src="' + iconurl + '">';
        if (markergrouping == 'grouped') {
          map.addLayer(markers);
          var name = imageurl + ' ' + '{{category_name}}';
          overLayers.push({ "name": name, "layer": groups[counter] });
        } else if (markergrouping == 'single') {
          overLayers.push({ "name": '{{category_name}}', icon: imageurl, active: true, "layer": L.layerGroup(layers) });
        }
        {% endfor %}

        // Add category control to map
        if (markergrouping == 'grouped') {
          for (i = 0; i < overLayers.length; i++) {
            control.addOverlay(overLayers[i]['layer'], overLayers[i]['name']);
            control.addTo(map);
            overLayers[i]['layer'].addTo(map);
          }
        } else if (markergrouping == 'single') {
          var panelLayers = new L.Control.PanelLayers(null, overLayers, {
            compact: true,
            collapsed: false,
            position: 'topleft'
          });
          map.addControl(panelLayers);
        }

        // GeoJSON Layers
        var boundariesLayer = L.geoJSON(null, {
          onEachFeature: function (feature, layer) {
            var center = layer.getBounds().getCenter();
            var communityName = feature.properties.community || 'Unknown';
            var formattedCommunityName = communityName.split(' ').join('<br>');
            var communityLabel = L.divIcon({
              className: 'community-label',
              html: '<div>' + formattedCommunityName + '</div>',
              iconSize: [100, 20]
            });
            L.marker(center, { icon: communityLabel }).addTo(map);
          }
        });
        fetch('https://profrovner.github.io/antimonumentalchicago/boundaries.geojson')
          .then(response => response.json())
          .then(data => boundariesLayer.addData(data))
          .then(() => map.addLayer(boundariesLayer));  // Visible by default

        var landmarksLayer = L.geoJSON(null, {
          onEachFeature: function (feature, layer) {
            var popupContent = '<strong>' + (feature.properties.NAME || 'Unknown') + '</strong><br>' +
                               '<em>Architect:</em> ' + (feature.properties.ARCHITECT || 'Unknown') + '<br>' +
                               '<em>Address:</em> ' + (feature.properties.ADDRESS || 'Unknown') + '<br>' +
                               '<em>Date Built:</em> ' + (feature.properties.DATE_BUILT || 'Unknown');
            layer.bindPopup(popupContent);
          }
        });
        fetch('https://profrovner.github.io/antimonumentalchicago/landmarkareas.geojson')
          .then(response => response.json())
          .then(data => landmarksLayer.addData(data))
          .then(() => map.addLayer(landmarksLayer));  // Visible by default

        var monumentsLayer = L.geoJSON(null, {
          onEachFeature: function (feature, layer) {
            var popupContent = '<strong>' + (feature.properties.Title || 'Unknown') + '</strong><br>' +
                               '<em>Year Built:</em> ' + (feature.properties['Year Built'] || 'Unknown') + '<br>' +
                               '<em>Location (Neighborhood Name):</em> ' + (feature.properties['Location (neighborhood Name)'] || 'Unknown') + '<br>' +
                               '<em>Architect/Designer:</em> ' + (feature.properties['Architect/designer'] || 'Unknown');
            layer.bindPopup(popupContent);
          }
        });
        fetch('https://profrovner.github.io/antimonumentalchicago/monuments.geojson')
          .then(response => response.json())
          .then(data => monumentsLayer.addData(data))
          .then(() => map.addLayer(monumentsLayer));  // Visible by default

        // Create a separate overlay control for GeoJSON layers
        var geojsonLayerControl = {
          "Community Areas": boundariesLayer,
          "Landmarks": landmarksLayer,
          "Monuments": monumentsLayer
        };

        // Add GeoJSON layer control to the bottom-right of the map
        L.control.layers(null, geojsonLayerControl, { position: 'bottomright', collapsed: false }).addTo(map);

        return items;
      }
    </script>

    {% include menu.html %}
    {% include dropdown.html %}
  </body>
</html>
