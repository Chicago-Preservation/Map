<!DOCTYPE html> 
<html>

  {% include head.html %}

  <body>

    {% include sidebar.html %}
       <script>
        window.onload = function() {
          if (localStorage['selectedtem'] != undefined) {
            new_map();
          } else {
            new_map('{{site.marker-grouping}}');
          }
          reloadhtml();
        };
        window.onhashchange = function() {
          reloadhtml();
        };
       </script>

    <div id="map" style="width: 100%; height: 600px;"></div>

    <script>

    var map = L.map('map', {scrollWheelZoom: false}).setView([41.8781, -87.6298], 12); // Default view centered on Chicago
    var chicagoBounds = [[41.644543, -87.940267], [42.023131, -87.523661]]; // Bounding box for Chicago area
    map.fitBounds(chicagoBounds); // Fit the map to Chicago bounds
    var markers = '';

    window.change_map = function() {
      localStorage.setItem('selectedtem', document.getElementById("choose").value);
      new_map();
    };

    function makeMap(markergrouping, map) {
      if (markergrouping == 'grouped') {
        markers = new L.markerClusterGroup({showCoverageOnHover: false});
      } else if (markergrouping == 'single') {
        markers = new L.featureGroup();
      }
      var items = {};

      // Base map layer (ESRI Gray Light)
      L.tileLayer('{{site.map-tileset}}', {
        attribution: '{{site.map-credits}}',
        minZoom: {{site.minZoom}},
        maxZoom: {{site.maxZoom}},
        errorTileUrl: "img/error-tile-image.png",
        subdomains: ["a", "b", "c", "d"],
        detectRetina: true,
      }).addTo(map);

      // Adding NR Properties GeoJSON Layer
      var nrPropertiesLayer = L.geoJSON(null, {
        onEachFeature: function (feature, layer) {
          var popupContent = '<strong>' +
            (feature.properties.SignificantName || 'No Name') +
            '</strong><br>' +
            '<em>Location:</em> ' + (feature.properties.Location || 'Unknown') + '<br>' +
            '<em>Architect:</em> ' + (feature.properties.Architect || 'Unknown') + '<br>' +
            '<em>Begin Year:</em> ' + (feature.properties.BeginYear || 'Unknown') + '<br>' +
            '<em>End Year:</em> ' + (feature.properties.EndYear || 'Unknown');
          layer.bindPopup(popupContent);
        },
        style: function (feature) {
          return {
            color: "#3388ff",
            weight: 2,
            fillOpacity: 0.6
          };
        }
      });

      fetch('https://Chicago-Preservation.github.io/Map/NR_Properties_filtered.geojson')
        .then(response => response.json())
        .then(data => {
          nrPropertiesLayer.addData(data);
          map.addLayer(nrPropertiesLayer);
        })
        .catch(error => console.error('Error loading NR Properties GeoJSON:', error));

      // Adding Landmarks Layer
      var landmarksLayer = L.geoJSON(null, {
        onEachFeature: function (feature, layer) {
          var popupContent = '<strong>' + (feature.properties.NAME || 'Unknown') + '</strong><br>' +
            '<em>Architect:</em> ' + (feature.properties.ARCHITECT || 'Unknown') + '<br>' +
            '<em>Address:</em> ' + (feature.properties.ADDRESS || 'Unknown') + '<br>' +
            '<em>Date Built:</em> ' + (feature.properties.DATE_BUILT || 'Unknown');
          layer.bindPopup(popupContent);
        }
      });

      fetch('https://Chicago-Preservation.github.io/Map/landmarkareas.geojson')
        .then(response => response.json())
        .then(data => {
          landmarksLayer.addData(data);
          map.addLayer(landmarksLayer);
        })
        .catch(error => console.error('Error loading Landmarks GeoJSON:', error));

      // Adding Community Boundaries Layer
      var boundariesLayer = L.geoJSON(null, {
        style: function (feature) {
          return {
            color: "#000000",
            weight: 2,
            fillOpacity: 0
          };
        },
        onEachFeature: function (feature, layer) {
          var center = layer.getBounds().getCenter();
          var communityName = feature.properties.community || 'Unknown';
          var formattedCommunityName = communityName.split(' ').join('<br>');
          var communityLabel = L.divIcon({
            className: 'community-label',
            html: '<div>' + formattedCommunityName + '</div>',
            iconSize: [100, 20]
          });
          L.marker(center, { icon: communityLabel }).addTo(map);
        }
      });

      fetch('https://Chicago-Preservation.github.io/Map/boundaries.geojson')
        .then(response => response.json())
        .then(data => {
          boundariesLayer.addData(data);
          map.addLayer(boundariesLayer);
        })
        .catch(error => console.error('Error loading Boundaries GeoJSON:', error));
    }

    // Initialize the map with default grouping
    makeMap('{{site.marker-grouping}}', map);

    </script>

    {% include menu.html %}
    {% include dropdown.html %}
  </body>
</html>
